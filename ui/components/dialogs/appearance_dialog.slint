// ============================================================================
// APPEARANCE DIALOG
// ============================================================================
// Focused dialog for theme, typography, and tool toggles.

import { MaterialPalette } from "../../material/ui/styling/material_palette.slint";
import { MaterialTypography } from "../../material/ui/styling/material_typography.slint";
import { MaterialText } from "../../material/ui/components/material_text.slint";
import { FilledButton } from "../../material/ui/components/filled_button.slint";
import { TextButton } from "../../material/ui/components/text_button.slint";
import { Slider } from "../../material/ui/components/slider.slint";
import { CheckBox, CheckState } from "../../material/ui/components/check_box.slint";
import { ScrollView } from "std-widgets.slint";
import { HorizontalBox, VerticalBox, ComboBox } from "std-widgets.slint";

// Helper controls ------------------------------------------------------------
component SettingsCheckBox inherits HorizontalLayout {
    in property <string> text;
    in-out property <bool> checked;
    spacing: 8px;

    CheckBox {
        check-state: root.checked ? CheckState.checked : CheckState.unchecked;
        checked-state-changed(s) => { root.checked = s == CheckState.checked; }
    }
    MaterialText {
        text: root.text;
        vertical-alignment: center;
        style: MaterialTypography.body-medium;
        color: MaterialPalette.on-surface;
    }
}

component SettingsSlider inherits VerticalLayout {
    in property <string> label;
    in property <string> unit: "";
    in-out property <float> value;
    in property <float> minimum: 0;
    in property <float> maximum: 100;
    spacing: 4px;

    HorizontalLayout {
        MaterialText {
            text: root.label + ":";
            style: MaterialTypography.body-medium;
            color: MaterialPalette.on-surface;
            vertical-alignment: center;
        }
        Rectangle { horizontal-stretch: 1; }
        MaterialText {
            text: Math.round(root.value) + root.unit;
            style: MaterialTypography.body-medium;
            color: MaterialPalette.on-primary;
            vertical-alignment: center;
        }
    }
    Slider {
        value <=> root.value;
        minimum: root.minimum;
        maximum: root.maximum;
    }
}

// Main dialog ---------------------------------------------------------------
export component AppearanceDialog {
    in-out property <bool> show-dialog: false;
    in-out property <string> theme-selection: "dark";
    in-out property <float> text-size: 14;
    in-out property <float> ui-scale: 100;
    in-out property <bool> enable-points: true;
    in-out property <bool> enable-bboxes: true;
    in-out property <bool> enable-polygons: true;
    in-out property <bool> randomize-dataset: false;

    callback apply();
    callback cancel();
    callback reset-to-defaults();

    if root.show-dialog: Rectangle {
        width: 100%;
        height: 100%;
        background: MaterialPalette.scrim.with-alpha(0.7);

        TouchArea { clicked => { } }

        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 640px;
            height: 520px;
            background: MaterialPalette.primary_container;
            border-radius: 8px;
            border-color: MaterialPalette.primary;
            border-width: 1px;

            VerticalLayout {
                // Header
                Rectangle {
                    height: 56px;
                    background: MaterialPalette.primary;

                    HorizontalLayout {
                        padding-left: 20px;
                        padding-right: 12px;

                        MaterialText {
                            text: "Appearance";
                            style: MaterialTypography.title-medium;
                            color: MaterialPalette.on_primary;
                            vertical-alignment: center;
                        }

                        Rectangle { horizontal-stretch: 1; }

                        TextButton {
                            text: "Close";
                            clicked => { root.cancel(); }
                        }
                    }
                }

                // Content
                Rectangle {
                    vertical-stretch: 1;
                    background: MaterialPalette.surface_container;

                    ScrollView {
                        VerticalLayout {
                            padding: 20px;
                            spacing: 18px;

                            // Theme
                            VerticalLayout {
                                spacing: 10px;
                                MaterialText {
                                    text: "Theme";
                                    style: MaterialTypography.title-small;
                                    color: MaterialPalette.on_surface;
                                }

                                HorizontalLayout {
                                    spacing: 12px;
                                    MaterialText {
                                        text: "Color Scheme";
                                        width: 140px;
                                        vertical-alignment: center;
                                    }
                                    ComboBox {
                                        model: ["Dark", "Light"];
                                        current-value: root.theme-selection == "dark" ? "Dark" : "Light";
                                        selected => {
                                            root.theme-selection = self.current-value == "Dark" ? "dark" : "light";
                                        }
                                    }
                                }
                            }

                            // Typography & scale
                            VerticalLayout {
                                spacing: 12px;
                                MaterialText {
                                    text: "Typography";
                                    style: MaterialTypography.title-small;
                                    color: MaterialPalette.on_surface;
                                }

                                SettingsSlider {
                                    label: "Base Text Size";
                                    unit: "px";
                                    value <=> root.text-size;
                                    minimum: 10;
                                    maximum: 24;
                                }

                                SettingsSlider {
                                    label: "UI Scale";
                                    unit: "%";
                                    value <=> root.ui-scale;
                                    minimum: 75;
                                    maximum: 150;
                                }
                            }

                            // Tool toggles
                            VerticalLayout {
                                spacing: 10px;
                                MaterialText {
                                    text: "Tools";
                                    style: MaterialTypography.title-small;
                                    color: MaterialPalette.on_surface;
                                }

                                SettingsCheckBox { text: "Enable Center Points (C)"; checked <=> root.enable-points; }
                                SettingsCheckBox { text: "Enable Bounding Boxes (B)"; checked <=> root.enable-bboxes; }
                                SettingsCheckBox { text: "Enable Polygons (S hold)"; checked <=> root.enable-polygons; }
                                SettingsCheckBox { text: "Randomize dataset on load"; checked <=> root.randomize-dataset; }
                            }
                        }
                    }
                }

                // Footer
                Rectangle {
                    height: 64px;
                    background: MaterialPalette.surface_container_high;

                    HorizontalLayout {
                        padding: 12px;
                        padding-left: 20px;
                        padding-right: 20px;
                        spacing: 12px;

                        TextButton {
                            text: "Reset";
                            clicked => { root.reset-to-defaults(); }
                        }

                        Rectangle { horizontal-stretch: 1; }

                        TextButton {
                            text: "Cancel";
                            clicked => { root.cancel(); }
                        }

                        FilledButton {
                            text: "Apply";
                            clicked => { root.apply(); }
                        }
                    }
                }
            }
        }
    }
}
