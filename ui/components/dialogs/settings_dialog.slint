// ============================================================================
// COMPREHENSIVE SETTINGS DIALOG
// ============================================================================
// Full-featured settings with tabs for Appearance, Layout, and Keybindings

import { MaterialPalette } from "../../material/ui/styling/material_palette.slint";
import { MaterialTypography } from "../../material/ui/styling/material_typography.slint";
import { MaterialText } from "../../material/ui/components/material_text.slint";
import { FilledButton } from "../../material/ui/components/filled_button.slint";
import { TextButton } from "../../material/ui/components/text_button.slint";
import { TonalButton } from "../../material/ui/components/tonal_button.slint";
import { CheckBox, CheckState } from "../../material/ui/components/check_box.slint";
import { Slider } from "../../material/ui/components/slider.slint";
import { ScrollView } from "std-widgets.slint";
import { VerticalBox, HorizontalBox, ComboBox } from "std-widgets.slint";

// ============================================================================
// HELPER COMPONENTS
// ============================================================================

component SettingsCheckBox inherits HorizontalLayout {
    in property <string> text;
    in-out property <bool> checked;
    spacing: 8px;

    CheckBox {
         check-state: root.checked ? CheckState.checked : CheckState.unchecked;
         checked-state-changed(s) => { root.checked = s == CheckState.checked; }
    }
    MaterialText {
         text: root.text;
         vertical-alignment: center;
         style: MaterialTypography.body-medium;
         color: MaterialPalette.on-surface;
    }
}

component SettingsSlider inherits VerticalLayout {
    in property <string> label;
    in property <string> unit: "";
    in-out property <float> value;
    in property <float> minimum: 0;
    in property <float> maximum: 100;
    spacing: 4px;

    HorizontalLayout {
        MaterialText {
            text: root.label + ":";
            style: MaterialTypography.body-medium;
            color: MaterialPalette.on-surface;
            vertical-alignment: center;
        }
        Rectangle { horizontal-stretch: 1; }
        MaterialText {
            text: Math.round(root.value) + root.unit;
            style: MaterialTypography.body-medium;
            color: MaterialPalette.primary;
            vertical-alignment: center;
        }
    }
    Slider {
        value <=> root.value;
        minimum: root.minimum;
        maximum: root.maximum;
    }
}

component KeybindingRow inherits Rectangle {
    in property <string> action;
    in property <string> current-key;
    in property <string> description;

    callback edit-binding();

    height: 48px;
    background: transparent;

    HorizontalLayout {
        padding: 8px;
        spacing: 12px;

        // Action name
        VerticalLayout {
            width: 180px;
            MaterialText {
                text: root.action;
                style: MaterialTypography.body-medium;
                color: MaterialPalette.on-surface;
            }
            MaterialText {
                text: root.description;
                style: MaterialTypography.body-small;
                color: MaterialPalette.on-surface-variant;
            }
        }

        Rectangle { horizontal-stretch: 1; }

        // Current keybinding
        Rectangle {
            width: 120px;
            height: 32px;
            background: MaterialPalette.surface-container-highest;
            border-radius: 8px;

            MaterialText {
                text: root.current-key;
                style: MaterialTypography.label-large;
                color: MaterialPalette.on-surface;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        // Edit button
        TextButton {
            text: "Edit";
            clicked => { root.edit-binding(); }
        }
    }
}

// ============================================================================
// MAIN SETTINGS DIALOG
// ============================================================================

export component SettingsDialog {
    in-out property <bool> show-dialog: false;

    // Current tab
    in-out property <int> current-tab: 0;

    // ========================================================================
    // APPEARANCE SETTINGS
    // ========================================================================
    in-out property <string> theme-selection: "dark";
    in-out property <float> text-size: 14;
    in-out property <float> ui-scale: 100;

    // ========================================================================
    // LAYOUT SETTINGS
    // ========================================================================
    in-out property <float> sidebar-width: 250;
    in-out property <float> topbar-height: 48;
    in-out property <float> bottombar-height: 32;
    in-out property <bool> sidebar-left: true;

    // ========================================================================
    // ANNOTATION SETTINGS
    // ========================================================================
    in-out property <bool> enable-points: true;
    in-out property <bool> enable-bboxes: true;
    in-out property <bool> enable-polygons: true;
    in-out property <bool> randomize-dataset: false;

    // ========================================================================
    // CALLBACKS
    // ========================================================================
    callback apply-settings();
    callback cancel();
    callback reset-to-defaults();

    // ========================================================================
    // MODAL OVERLAY
    // ========================================================================
    if root.show-dialog: Rectangle {
        width: 100%;
        height: 100%;
        background: MaterialPalette.scrim.with-alpha(0.7);

        TouchArea {
            // Prevent clicks from passing through
            clicked => { }
        }

        // ====================================================================
        // DIALOG CONTAINER
        // ====================================================================
        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 700px;
            height: 600px;
            background: MaterialPalette.surface-container;
            border-radius: 28px;

            VerticalLayout {
                padding: 0px;

                // ============================================================
                // HEADER
                // ============================================================
                Rectangle {
                    height: 64px;
                    background: MaterialPalette.surface-container-high;
                    border-radius: 28px;

                    HorizontalLayout {
                        padding-left: 24px;
                        padding-right: 24px;

                        MaterialText {
                            text: "Settings";
                            style: MaterialTypography.headline-small;
                            color: MaterialPalette.on-surface;
                            vertical-alignment: center;
                        }

                        Rectangle { horizontal-stretch: 1; }

                        TextButton {
                            text: "×";
                            clicked => { root.cancel(); }
                        }
                    }
                }

                // ============================================================
                // TAB BAR
                // ============================================================
                Rectangle {
                    height: 48px;
                    background: MaterialPalette.surface-container-high;

                    HorizontalLayout {
                        padding-left: 24px;
                        spacing: 4px;

                        // Appearance Tab
                        Rectangle {
                            width: 140px;
                            background: root.current-tab == 0 ? MaterialPalette.primary-container : transparent;
                            border-radius: 8px;

                            MaterialText {
                                text: "Appearance";
                                style: MaterialTypography.label-large;
                                color: root.current-tab == 0 ? MaterialPalette.on-primary-container : MaterialPalette.on-surface-variant;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }

                            TouchArea {
                                clicked => { root.current-tab = 0; }
                            }
                        }

                        // Layout Tab
                        Rectangle {
                            width: 140px;
                            background: root.current-tab == 1 ? MaterialPalette.primary-container : transparent;
                            border-radius: 8px;

                            MaterialText {
                                text: "Layout";
                                style: MaterialTypography.label-large;
                                color: root.current-tab == 1 ? MaterialPalette.on-primary-container : MaterialPalette.on-surface-variant;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }

                            TouchArea {
                                clicked => { root.current-tab = 1; }
                            }
                        }

                        // Keybindings Tab
                        Rectangle {
                            width: 140px;
                            background: root.current-tab == 2 ? MaterialPalette.primary-container : transparent;
                            border-radius: 8px;

                            MaterialText {
                                text: "Keybindings";
                                style: MaterialTypography.label-large;
                                color: root.current-tab == 2 ? MaterialPalette.on-primary-container : MaterialPalette.on-surface-variant;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }

                            TouchArea {
                                clicked => { root.current-tab = 2; }
                            }
                        }
                    }
                }

                // ============================================================
                // TAB CONTENT
                // ============================================================
                Rectangle {
                    vertical-stretch: 1;

                    // ========================================================
                    // APPEARANCE TAB
                    // ========================================================
                    if root.current-tab == 0: ScrollView {
                        VerticalLayout {
                            padding: 24px;
                            spacing: 24px;

                            // Theme Section
                            VerticalLayout {
                                spacing: 12px;

                                MaterialText {
                                    text: "Theme";
                                    style: MaterialTypography.title-medium;
                                    color: MaterialPalette.primary;
                                }

                                HorizontalLayout {
                                    spacing: 12px;

                                    MaterialText {
                                        text: "Color Scheme:";
                                        width: 150px;
                                        vertical-alignment: center;
                                    }

                                    ComboBox {
                                        model: ["Dark", "Light"];
                                        current-value: root.theme-selection == "dark" ? "Dark" : "Light";
                                        selected => {
                                            root.theme-selection = self.current-value == "Dark" ? "dark" : "light";
                                        }
                                    }
                                }
                            }

                            // Text Size Section
                            VerticalLayout {
                                spacing: 12px;

                                MaterialText {
                                    text: "Typography";
                                    style: MaterialTypography.title-medium;
                                    color: MaterialPalette.primary;
                                }

                                SettingsSlider {
                                    label: "Base Text Size";
                                    unit: "px";
                                    value <=> root.text-size;
                                    minimum: 10;
                                    maximum: 24;
                                }

                                SettingsSlider {
                                    label: "UI Scale";
                                    unit: "%";
                                    value <=> root.ui-scale;
                                    minimum: 75;
                                    maximum: 150;
                                }
                            }

                            // Annotation Modes
                            VerticalLayout {
                                spacing: 12px;

                                MaterialText {
                                    text: "Annotation Tools";
                                    style: MaterialTypography.title-medium;
                                    color: MaterialPalette.primary;
                                }

                                SettingsCheckBox {
                                    text: "Enable Center Points (C key)";
                                    checked <=> root.enable-points;
                                }

                                SettingsCheckBox {
                                    text: "Enable Bounding Boxes (B key)";
                                    checked <=> root.enable-bboxes;
                                }

                                SettingsCheckBox {
                                    text: "Enable Polygons (S key)";
                                    checked <=> root.enable-polygons;
                                }
                            }

                            // Dataset Options
                            VerticalLayout {
                                spacing: 12px;

                                MaterialText {
                                    text: "Dataset";
                                    style: MaterialTypography.title-medium;
                                    color: MaterialPalette.primary;
                                }

                                SettingsCheckBox {
                                    text: "Randomize dataset order on load";
                                    checked <=> root.randomize-dataset;
                                }
                            }
                        }
                    }

                    // ========================================================
                    // LAYOUT TAB
                    // ========================================================
                    if root.current-tab == 1: ScrollView {
                        VerticalLayout {
                            padding: 24px;
                            spacing: 24px;

                            // Panel Sizes
                            VerticalLayout {
                                spacing: 12px;

                                MaterialText {
                                    text: "Panel Dimensions";
                                    style: MaterialTypography.title-medium;
                                    color: MaterialPalette.primary;
                                }

                                SettingsSlider {
                                    label: "Sidebar Width";
                                    unit: "px";
                                    value <=> root.sidebar-width;
                                    minimum: 200;
                                    maximum: 400;
                                }

                                SettingsSlider {
                                    label: "Top Bar Height";
                                    unit: "px";
                                    value <=> root.topbar-height;
                                    minimum: 40;
                                    maximum: 80;
                                }

                                SettingsSlider {
                                    label: "Bottom Bar Height";
                                    unit: "px";
                                    value <=> root.bottombar-height;
                                    minimum: 24;
                                    maximum: 48;
                                }
                            }

                            // Panel Positions
                            VerticalLayout {
                                spacing: 12px;

                                MaterialText {
                                    text: "Panel Positions";
                                    style: MaterialTypography.title-medium;
                                    color: MaterialPalette.primary;
                                }

                                HorizontalLayout {
                                    spacing: 12px;

                                    MaterialText {
                                        text: "Sidebar Position:";
                                        width: 150px;
                                        vertical-alignment: center;
                                    }

                                    ComboBox {
                                        model: ["Left", "Right"];
                                        current-value: root.sidebar-left ? "Left" : "Right";
                                        selected => {
                                            root.sidebar-left = self.current-value == "Left";
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // ========================================================
                    // KEYBINDINGS TAB
                    // ========================================================
                    if root.current-tab == 2: ScrollView {
                        VerticalLayout {
                            padding: 24px;
                            spacing: 16px;

                            MaterialText {
                                text: "Keyboard Shortcuts";
                                style: MaterialTypography.title-medium;
                                color: MaterialPalette.primary;
                            }

                            MaterialText {
                                text: "Click 'Edit' to change a keybinding. Press Esc to cancel editing.";
                                style: MaterialTypography.body-small;
                                color: MaterialPalette.on-surface-variant;
                            }

                            // Navigation
                            MaterialText {
                                text: "Navigation";
                                style: MaterialTypography.title-small;
                                color: MaterialPalette.secondary;
                            }

                            KeybindingRow {
                                action: "Next Image";
                                current-key: "Space / →";
                                description: "Move to next image";
                            }

                            KeybindingRow {
                                action: "Previous Image";
                                current-key: "Shift+Space / ←";
                                description: "Move to previous image";
                            }

                            KeybindingRow {
                                action: "Reset View";
                                current-key: "H / Ctrl+0";
                                description: "Reset zoom and pan";
                            }

                            // Drawing Tools
                            MaterialText {
                                text: "Drawing Tools";
                                style: MaterialTypography.title-small;
                                color: MaterialPalette.secondary;
                            }

                            KeybindingRow {
                                action: "BBox Tool";
                                current-key: "B";
                                description: "Draw bounding boxes";
                            }

                            KeybindingRow {
                                action: "Point Tool";
                                current-key: "C";
                                description: "Place center points";
                            }

                            KeybindingRow {
                                action: "Polygon Tool";
                                current-key: "S (hold)";
                                description: "Draw polygons";
                            }

                            KeybindingRow {
                                action: "Delete Mode";
                                current-key: "Q (hold)";
                                description: "Delete annotations";
                            }

                            KeybindingRow {
                                action: "Auto-Resize";
                                current-key: "A (hold)";
                                description: "Auto-resize with edge detection";
                            }

                            // Classes
                            MaterialText {
                                text: "Class Selection";
                                style: MaterialTypography.title-small;
                                color: MaterialPalette.secondary;
                            }

                            KeybindingRow {
                                action: "Class 1";
                                current-key: "1";
                                description: "Select class 1";
                            }

                            KeybindingRow {
                                action: "Class 2";
                                current-key: "2";
                                description: "Select class 2";
                            }

                            KeybindingRow {
                                action: "Class 3";
                                current-key: "3";
                                description: "Select class 3";
                            }

                            KeybindingRow {
                                action: "Class 4";
                                current-key: "4";
                                description: "Select class 4";
                            }

                            KeybindingRow {
                                action: "Class 5";
                                current-key: "5";
                                description: "Select class 5";
                            }

                            // Editing
                            MaterialText {
                                text: "Editing";
                                style: MaterialTypography.title-small;
                                color: MaterialPalette.secondary;
                            }

                            KeybindingRow {
                                action: "Undo";
                                current-key: "Ctrl+Z";
                                description: "Undo last action";
                            }

                            KeybindingRow {
                                action: "Redo";
                                current-key: "Ctrl+Shift+Z / Ctrl+Y";
                                description: "Redo last undone action";
                            }

                            KeybindingRow {
                                action: "Copy";
                                current-key: "Ctrl+C";
                                description: "Copy selected annotation";
                            }

                            KeybindingRow {
                                action: "Paste";
                                current-key: "Ctrl+V";
                                description: "Paste annotation";
                            }

                            KeybindingRow {
                                action: "Select All";
                                current-key: "Ctrl+A";
                                description: "Select all annotations";
                            }

                            KeybindingRow {
                                action: "Delete Selected";
                                current-key: "Del / Backspace";
                                description: "Delete selected annotations";
                            }

                            // File
                            MaterialText {
                                text: "File Operations";
                                style: MaterialTypography.title-small;
                                color: MaterialPalette.secondary;
                            }

                            KeybindingRow {
                                action: "Save";
                                current-key: "Ctrl+S";
                                description: "Save dataset";
                            }

                            KeybindingRow {
                                action: "Frame Complete";
                                current-key: "F";
                                description: "Toggle frame completion";
                            }
                        }
                    }
                }

                // ============================================================
                // FOOTER BUTTONS
                // ============================================================
                Rectangle {
                    height: 64px;
                    background: MaterialPalette.surface-container-high;

                    HorizontalLayout {
                        padding: 16px;
                        padding-left: 24px;
                        padding-right: 24px;
                        spacing: 12px;

                        TextButton {
                            text: "Reset to Defaults";
                            clicked => { root.reset-to-defaults(); }
                        }

                        Rectangle { horizontal-stretch: 1; }

                        TextButton {
                            text: "Cancel";
                            clicked => { root.cancel(); }
                        }

                        FilledButton {
                            text: "Apply";
                            clicked => { root.apply-settings(); }
                        }
                    }
                }
            }
        }
    }
}
