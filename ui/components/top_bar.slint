// ============================================================================
// TOP BAR COMPONENT
// ============================================================================
// The main menu bar at the top of the application window
// Menus on left, navigation in center, actions on right

import { MaterialPalette } from "../material/ui/styling/material_palette.slint";
import { MaterialTypography } from "../material/ui/styling/material_typography.slint";
import { PopupMenu } from "../material/ui/components/menu.slint";
import { MenuItem } from "../material/ui/items/menu_item.slint";
import { MaterialStyleMetrics } from "../material/ui/styling/material_style_metrics.slint";
import { MaterialText } from "../material/ui/components/material_text.slint";
import { Icon } from "../material/ui/components/icon.slint";
import { Icons } from "../material/ui/icons/icons.slint";

// ============================================================================
// MENU BUTTON COMPONENT - Rectangular with small radius
// ============================================================================
component MenuButton inherits Rectangle {
    in property <string> text;
    in property <bool> is-open;
    in property <color> bg-color: MaterialPalette.surface-container;
    in property <color> bg-hover-color: MaterialPalette.surface-container-high;
    in property <color> bg-active-color: MaterialPalette.primary-container;
    in property <color> text-color: MaterialPalette.on-surface;
    in property <color> text-active-color: MaterialPalette.on-primary-container;
    callback clicked();
    callback hovered();

    width: 60px;
    height: 32px;
    border-radius: 4px;
    background: root.is-open ? root.bg-active-color :
                (touch.has-hover ? root.bg-hover-color : root.bg-color);

    MaterialText {
        text: root.text;
        style: MaterialTypography.label-large;
        color: root.is-open ? root.text-active-color : root.text-color;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
        mouse-cursor: pointer;

        moved => {
            if (self.has-hover) {
                root.hovered();
            }
        }
    }
}

// ============================================================================
// CIRCULAR NAVIGATION BUTTON
// ============================================================================
component NavButton inherits Rectangle {
    in property <image> icon;
    in property <color> bg-color: MaterialPalette.surface-container;
    in property <color> bg-hover-color: MaterialPalette.surface-container-highest;
    in property <color> icon-color: MaterialPalette.on-surface;
    callback clicked();

    width: 32px;
    height: 32px;
    border-radius: 16px;
    background: touch.has-hover ? root.bg-hover-color : root.bg-color;

    Icon {
        source: root.icon;
        colorize: root.icon-color;
        width: 20px;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
        mouse-cursor: pointer;
    }
}

export component TopBar {
    // ========================================================================
    // FILE MENU CALLBACKS
    // ========================================================================
    callback file-open-dataset();
    callback file-new-dataset();
    callback file-save();
    callback file-export-coco();
    callback file-export-voc();

    // ========================================================================
    // VIEW MENU CALLBACKS
    // ========================================================================
    callback view-reset();
    callback view-toggle-sidebar();
    callback view-theme-dark();
    callback view-theme-light();

    // ========================================================================
    // TOOLS MENU CALLBACKS
    // ========================================================================
    callback tools-appearance();
    callback tools-layout();
    callback tools-keybindings();

    // ========================================================================
    // NAVIGATION CALLBACKS
    // ========================================================================
    callback first-image();
    callback prev-image();
    callback randomize();
    callback next-image();
    callback last-image();

    // ========================================================================
    // MENU STATE - Track which menu is open
    // ========================================================================
    property <bool> file-menu-open: false;
    property <bool> view-menu-open: false;
    property <bool> tools-menu-open: false;
    property <bool> any-menu-open: root.file-menu-open || root.view-menu-open || root.tools-menu-open;

    // ========================================================================
    // LAYOUT PROPERTIES
    // ========================================================================
    min-height: 40px;  // Thinner to fit 32px buttons

    // ========================================================================
    // MAIN CONTAINER
    // ========================================================================
    Rectangle {
        background: MaterialPalette.surface;

        // Bottom border separator
        Rectangle {
            y: parent.height - 1px;
            height: 1px;
            background: MaterialPalette.outline-variant;
        }

        HorizontalLayout {
            padding-left: MaterialStyleMetrics.padding-12;
            padding-right: MaterialStyleMetrics.padding-12;
            padding-top: 4px;
            padding-bottom: 4px;

            // ================================================================
            // LEFT SECTION - MENU BUTTONS
            // ================================================================
            HorizontalLayout {
                spacing: 4px;
                alignment: start;

                file-menu-button := MenuButton {
                    text: "File";
                    is-open: root.file-menu-open;
                    bg-color: MaterialPalette.primary-container;
                    bg-hover-color: MaterialPalette.primary-container;
                    bg-active-color: MaterialPalette.primary;
                    text-color: MaterialPalette.on-primary-container;
                    text-active-color: MaterialPalette.on-primary;
                    clicked => {
                        root.view-menu-open = false;
                        root.tools-menu-open = false;
                        root.file-menu-open = true;
                        view-menu.close();
                        tools-menu.close();
                        file-menu.show();
                    }
                    hovered => {
                        if (root.any-menu-open) {
                            root.view-menu-open = false;
                            root.tools-menu-open = false;
                            root.file-menu-open = true;
                            view-menu.close();
                            tools-menu.close();
                            file-menu.show();
                        }
                    }
                }

                view-menu-button := MenuButton {
                    text: "View";
                    is-open: root.view-menu-open;
                    bg-color: MaterialPalette.tertiary-container;
                    bg-hover-color: MaterialPalette.tertiary-container;
                    bg-active-color: MaterialPalette.tertiary;
                    text-color: MaterialPalette.on-tertiary-container;
                    text-active-color: MaterialPalette.on-tertiary;
                    clicked => {
                        root.file-menu-open = false;
                        root.tools-menu-open = false;
                        root.view-menu-open = true;
                        file-menu.close();
                        tools-menu.close();
                        view-menu.show();
                    }
                    hovered => {
                        if (root.any-menu-open) {
                            root.file-menu-open = false;
                            root.tools-menu-open = false;
                            root.view-menu-open = true;
                            file-menu.close();
                            tools-menu.close();
                            view-menu.show();
                        }
                    }
                }

                tools-menu-button := MenuButton {
                    text: "Tools";
                    is-open: root.tools-menu-open;
                    bg-color: MaterialPalette.secondary-container;
                    bg-hover-color: MaterialPalette.secondary-container;
                    bg-active-color: MaterialPalette.secondary;
                    text-color: MaterialPalette.on-secondary-container;
                    text-active-color: MaterialPalette.on-secondary;
                    clicked => {
                        root.file-menu-open = false;
                        root.view-menu-open = false;
                        root.tools-menu-open = true;
                        file-menu.close();
                        view-menu.close();
                        tools-menu.show();
                    }
                    hovered => {
                        if (root.any-menu-open) {
                            root.file-menu-open = false;
                            root.view-menu-open = false;
                            root.tools-menu-open = true;
                            file-menu.close();
                            view-menu.close();
                            tools-menu.show();
                        }
                    }
                }
            }

            // ================================================================
            // CENTER SECTION - NAVIGATION BUTTONS
            // ================================================================
            Rectangle { horizontal-stretch: 1; }  // Left spacer

            HorizontalLayout {
                spacing: 8px;
                alignment: center;

                // First button (skip to start)
                NavButton {
                    icon: Icons.skip-previous;
                    bg-color: MaterialPalette.primary-container;
                    bg-hover-color: MaterialPalette.primary;
                    icon-color: MaterialPalette.on-primary-container;
                    clicked => { root.first-image(); }
                }

                // Previous button
                NavButton {
                    icon: Icons.chevron-backward;
                    bg-color: MaterialPalette.tertiary-container;
                    bg-hover-color: MaterialPalette.tertiary;
                    icon-color: MaterialPalette.on-tertiary-container;
                    clicked => { root.prev-image(); }
                }

                // Randomize/Shuffle button
                NavButton {
                    icon: Icons.shuffle;
                    bg-color: MaterialPalette.error-container;
                    bg-hover-color: MaterialPalette.error;
                    icon-color: MaterialPalette.on-error-container;
                    clicked => { root.randomize(); }
                }

                // Next button
                NavButton {
                    icon: Icons.chevron-forward;
                    bg-color: MaterialPalette.tertiary-container;
                    bg-hover-color: MaterialPalette.tertiary;
                    icon-color: MaterialPalette.on-tertiary-container;
                    clicked => { root.next-image(); }
                }

                // Last button (skip to end)
                NavButton {
                    icon: Icons.skip-next;
                    bg-color: MaterialPalette.primary-container;
                    bg-hover-color: MaterialPalette.primary;
                    icon-color: MaterialPalette.on-primary-container;
                    clicked => { root.last-image(); }
                }
            }

            Rectangle { horizontal-stretch: 1; }  // Right spacer

            // ================================================================
            // RIGHT SECTION - ACTIONS
            // ================================================================
            HorizontalLayout {
                spacing: 4px;
                alignment: end;

                MenuButton {
                    text: "Save";
                    is-open: false;
                    bg-color: MaterialPalette.secondary-container;
                    bg-hover-color: MaterialPalette.secondary;
                    bg-active-color: MaterialPalette.secondary;
                    text-color: MaterialPalette.on-secondary-container;
                    text-active-color: MaterialPalette.on-secondary;
                    clicked => {
                        root.file-save();
                    }
                }
            }
        }
    }

    // ========================================================================
    // FILE MENU DROPDOWN
    // ========================================================================
    file-menu := PopupMenu {
        x: file-menu-button.absolute-position.x;
        y: file-menu-button.absolute-position.y + file-menu-button.height;

        items: [
            { text: "Open Dataset...", enabled: true },
            { text: "New Dataset...", enabled: true },
            { text: "Save", trailing-text: "Ctrl+S", enabled: true },
            { text: "Export COCO...", enabled: true },
            { text: "Export VOC...", enabled: true },
        ];

        activated(index) => {
            // Close menu and reset state
            self.close();
            root.file-menu-open = false;
            root.view-menu-open = false;
            root.tools-menu-open = false;

            // Handle menu action
            if (index == 0) { root.file-open-dataset(); }
            else if (index == 1) { root.file-new-dataset(); }
            else if (index == 2) { root.file-save(); }
            else if (index == 3) { root.file-export-coco(); }
            else if (index == 4) { root.file-export-voc(); }
        }
    }

    // ========================================================================
    // VIEW MENU DROPDOWN
    // ========================================================================
    view-menu := PopupMenu {
        x: view-menu-button.absolute-position.x;
        y: view-menu-button.absolute-position.y + view-menu-button.height;

        items: [
            { text: "Reset View", trailing-text: "H", enabled: true },
            { text: "Toggle Sidebar", enabled: true },
            { text: "Dark Theme", enabled: true },
            { text: "Light Theme", enabled: true },
        ];

        activated(index) => {
            // Close menu and reset state
            self.close();
            root.file-menu-open = false;
            root.view-menu-open = false;
            root.tools-menu-open = false;

            // Handle menu action
            if (index == 0) { root.view-reset(); }
            else if (index == 1) { root.view-toggle-sidebar(); }
            else if (index == 2) { root.view-theme-dark(); }
            else if (index == 3) { root.view-theme-light(); }
        }
    }

    // ========================================================================
    // TOOLS MENU DROPDOWN
    // ========================================================================
    tools-menu := PopupMenu {
        x: tools-menu-button.absolute-position.x;
        y: tools-menu-button.absolute-position.y + tools-menu-button.height;

        items: [
            { text: "Appearance…", enabled: true },
            { text: "Layout…", enabled: true },
            { text: "Keybindings…", enabled: true },
        ];

        activated(index) => {
            // Close menu and reset state
            self.close();
            root.file-menu-open = false;
            root.view-menu-open = false;
            root.tools-menu-open = false;

            // Handle menu action
            if (index == 0) { root.tools-appearance(); }
            else if (index == 1) { root.tools-layout(); }
            else if (index == 2) { root.tools-keybindings(); }
        }
    }
}
