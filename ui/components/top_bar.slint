// ============================================================================
// TOP BAR COMPONENT
// ============================================================================
// The main menu bar at the top of the application window
// Menus on the left, title in the center, quick actions on the right

import { MaterialPalette } from "../material/ui/styling/material_palette.slint";
import { MaterialTypography } from "../material/ui/styling/material_typography.slint";
import { TextButton } from "../material/ui/components/text_button.slint";
import { PopupMenu } from "../material/ui/components/menu.slint";
import { MenuItem } from "../material/ui/items/menu_item.slint";
import { MaterialStyleMetrics } from "../material/ui/styling/material_style_metrics.slint";
import { MaterialText } from "../material/ui/components/material_text.slint";

// ============================================================================
// MENU BUTTON COMPONENT - Rectangular with small radius
// ============================================================================
component MenuButton inherits Rectangle {
    in property <string> text;
    in property <bool> is-open;
    callback clicked();
    callback hovered();

    width: 60px;
    height: 32px;
    border-radius: 4px;
    background: root.is-open ? MaterialPalette.surface-container-highest :
                (touch.has-hover ? MaterialPalette.surface-container-high : transparent);

    MaterialText {
        text: root.text;
        style: MaterialTypography.label-large;
        color: MaterialPalette.on-surface;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
        mouse-cursor: pointer;

        moved => {
            if (self.has-hover) {
                root.hovered();
            }
        }
    }
}

export component TopBar {
    // ========================================================================
    // FILE MENU CALLBACKS
    // ========================================================================
    callback file-open-dataset();
    callback file-new-dataset();
    callback file-save();
    callback file-export-coco();
    callback file-export-voc();

    // ========================================================================
    // VIEW MENU CALLBACKS
    // ========================================================================
    callback view-reset();
    callback view-toggle-sidebar();
    callback view-theme-dark();
    callback view-theme-light();

    // ========================================================================
    // TOOLS MENU CALLBACKS
    // ========================================================================
    callback tools-settings();

    // ========================================================================
    // MENU STATE - Track which menu is open
    // ========================================================================
    property <bool> file-menu-open: false;
    property <bool> view-menu-open: false;
    property <bool> tools-menu-open: false;
    property <bool> any-menu-open: root.file-menu-open || root.view-menu-open || root.tools-menu-open;

    // ========================================================================
    // LAYOUT PROPERTIES
    // ========================================================================
    min-height: 48px;

    // ========================================================================
    // MAIN CONTAINER
    // ========================================================================
    Rectangle {
        background: MaterialPalette.surface;

        // Bottom border separator
        Rectangle {
            y: parent.height - 1px;
            height: 1px;
            background: MaterialPalette.outline-variant;
        }

        HorizontalLayout {
            padding-left: MaterialStyleMetrics.padding-16;
            padding-right: MaterialStyleMetrics.padding-16;

            // ================================================================
            // LEFT SECTION - MENU BUTTONS
            // ================================================================
            HorizontalLayout {
                spacing: 4px;
                alignment: start;

                file-menu-button := MenuButton {
                    text: "File";
                    is-open: root.file-menu-open;
                    clicked => {
                        root.view-menu-open = false;
                        root.tools-menu-open = false;
                        root.file-menu-open = true;
                        view-menu.close();
                        tools-menu.close();
                        file-menu.show();
                    }
                    hovered => {
                        if (root.any-menu-open) {
                            root.view-menu-open = false;
                            root.tools-menu-open = false;
                            root.file-menu-open = true;
                            view-menu.close();
                            tools-menu.close();
                            file-menu.show();
                        }
                    }
                }

                view-menu-button := MenuButton {
                    text: "View";
                    is-open: root.view-menu-open;
                    clicked => {
                        root.file-menu-open = false;
                        root.tools-menu-open = false;
                        root.view-menu-open = true;
                        file-menu.close();
                        tools-menu.close();
                        view-menu.show();
                    }
                    hovered => {
                        if (root.any-menu-open) {
                            root.file-menu-open = false;
                            root.tools-menu-open = false;
                            root.view-menu-open = true;
                            file-menu.close();
                            tools-menu.close();
                            view-menu.show();
                        }
                    }
                }

                tools-menu-button := MenuButton {
                    text: "Tools";
                    is-open: root.tools-menu-open;
                    clicked => {
                        root.file-menu-open = false;
                        root.view-menu-open = false;
                        root.tools-menu-open = true;
                        file-menu.close();
                        view-menu.close();
                        tools-menu.show();
                    }
                    hovered => {
                        if (root.any-menu-open) {
                            root.file-menu-open = false;
                            root.view-menu-open = false;
                            root.tools-menu-open = true;
                            file-menu.close();
                            view-menu.close();
                            tools-menu.show();
                        }
                    }
                }
            }

            // ================================================================
            // CENTER SECTION - APP TITLE
            // ================================================================
            Rectangle { horizontal-stretch: 1; }  // Left spacer

            MaterialText {
                text: "RADICAL Image Annotator v0.1";
                style: MaterialTypography.title-medium;
                vertical-alignment: center;
                horizontal-alignment: center;
                color: MaterialPalette.on-surface;
            }

            Rectangle { horizontal-stretch: 1; }  // Right spacer

            // ================================================================
            // RIGHT SECTION - QUICK ACTIONS
            // ================================================================
            HorizontalLayout {
                spacing: MaterialStyleMetrics.spacing-8;
                alignment: end;

                TextButton {
                    text: "Save";
                    clicked => {
                        root.file-save();
                    }
                }
            }
        }
    }

    // ========================================================================
    // FILE MENU DROPDOWN
    // ========================================================================
    file-menu := PopupMenu {
        x: file-menu-button.absolute-position.x;
        y: file-menu-button.absolute-position.y + file-menu-button.height;

        items: [
            { text: "Open Dataset...", enabled: true },
            { text: "New Dataset...", enabled: true },
            { text: "Save", trailing-text: "Ctrl+S", enabled: true },
            { text: "Export COCO...", enabled: true },
            { text: "Export VOC...", enabled: true },
        ];

        activated(index) => {
            // Close menu and reset state
            self.close();
            root.file-menu-open = false;
            root.view-menu-open = false;
            root.tools-menu-open = false;

            // Handle menu action
            if (index == 0) { root.file-open-dataset(); }
            else if (index == 1) { root.file-new-dataset(); }
            else if (index == 2) { root.file-save(); }
            else if (index == 3) { root.file-export-coco(); }
            else if (index == 4) { root.file-export-voc(); }
        }
    }

    // ========================================================================
    // VIEW MENU DROPDOWN
    // ========================================================================
    view-menu := PopupMenu {
        x: view-menu-button.absolute-position.x;
        y: view-menu-button.absolute-position.y + view-menu-button.height;

        items: [
            { text: "Reset View", trailing-text: "H", enabled: true },
            { text: "Toggle Sidebar", enabled: true },
            { text: "Dark Theme", enabled: true },
            { text: "Light Theme", enabled: true },
        ];

        activated(index) => {
            // Close menu and reset state
            self.close();
            root.file-menu-open = false;
            root.view-menu-open = false;
            root.tools-menu-open = false;

            // Handle menu action
            if (index == 0) { root.view-reset(); }
            else if (index == 1) { root.view-toggle-sidebar(); }
            else if (index == 2) { root.view-theme-dark(); }
            else if (index == 3) { root.view-theme-light(); }
        }
    }

    // ========================================================================
    // TOOLS MENU DROPDOWN
    // ========================================================================
    tools-menu := PopupMenu {
        x: tools-menu-button.absolute-position.x;
        y: tools-menu-button.absolute-position.y + tools-menu-button.height;

        items: [
            { text: "Settings...", enabled: true }
        ];

        activated(index) => {
            // Close menu and reset state
            self.close();
            root.file-menu-open = false;
            root.view-menu-open = false;
            root.tools-menu-open = false;

            // Handle menu action
            if (index == 0) { root.tools-settings(); }
        }
    }
}
