// ============================================================================
// SIDE PANEL COMPONENT
// ============================================================================
// The left sidebar containing tool selection, class list, and hierarchy view

import { MaterialPalette } from "../material/ui/styling/material_palette.slint";
import { MaterialTypography } from "../material/ui/styling/material_typography.slint";
import { MaterialStyleMetrics } from "../material/ui/styling/material_style_metrics.slint";
import { MaterialText } from "../material/ui/components/material_text.slint";
import { Icon } from "../material/ui/components/icon.slint";
import { Icons } from "../material/ui/icons/icons.slint";
import { ListView } from "std-widgets.slint";

// ============================================================================
// DATA STRUCTURES
// ============================================================================

export struct ClassItem {
    id: int,
    name: string,
    color: color,
    shortcut: string,
}

export struct HierarchyOption {
    key: int,
    label: string,
    is-leaf: bool,
}

// ============================================================================
// TOOL BUTTON COMPONENT
// ============================================================================

component ToolButton inherits Rectangle {
    in property <string> label;
    in property <image> icon-source;  // SVG icon source
    in property <bool> is-active;
    in property <color> bg-color: MaterialPalette.surface-container;
    in property <color> bg-active-color: MaterialPalette.primary-container;
    in property <color> icon-color: MaterialPalette.on-surface;
    in property <color> icon-active-color: MaterialPalette.on-primary-container;
    in property <color> label-color: MaterialPalette.on-surface-variant;
    in property <color> label-active-color: MaterialPalette.on-primary-container;

    callback clicked();

    height: 60px;
    background: root.is-active ? root.bg-active-color : root.bg-color;
    border-radius: 8px;

    VerticalLayout {
        padding: 8px;
        spacing: 6px;
        alignment: center;

        // Icon container (centered)
        Rectangle {
            height: 28px;

            Icon {
                source: root.icon-source;
                colorize: root.is-active ? root.icon-active-color : root.icon-color;
                width: 28px;
                height: 28px;
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
            }
        }

        // Label
        MaterialText {
            text: root.label;
            style: MaterialTypography.label-small;
            color: root.is-active ? root.label-active-color : root.label-color;
            horizontal-alignment: center;
        }
    }

    TouchArea {
        clicked => { root.clicked(); }
    }

    // Hover effect
    states [
        active when root.is-active : {
            background: root.bg-active-color;
        }
    ]
}

// ============================================================================
// SIDE PANEL COMPONENT
// ============================================================================

export component SidePanel {
    // ========================================================================
    // CLASS PROPERTIES
    // ========================================================================
    in property <[ClassItem]> classes;
    in-out property <int> current-class: 1;

    // ========================================================================
    // TOOL PROPERTIES
    // ========================================================================
    in-out property <string> current-tool: "Neutral";

    // ========================================================================
    // VISIBILITY PROPERTIES
    // ========================================================================
    in property <bool> show-sidebar: true;
    in property <length> sidebar-width: 250px;

    // ========================================================================
    // HIERARCHY PROPERTIES
    // ========================================================================
    in property <bool> hierarchy-mode: false;
    in property <string> hierarchy-breadcrumb: "";
    in property <string> hierarchy-prompt: "Select category";
    in property <[HierarchyOption]> hierarchy-options: [];

    // ========================================================================
    // CALLBACKS
    // ========================================================================
    callback class-selected(int);
    callback tool-selected(string);
    callback hierarchy-key-pressed(int);

    // ========================================================================
    // LAYOUT
    // ========================================================================
    width: root.show-sidebar ? root.sidebar-width : 0px;

    Rectangle {
        background: MaterialPalette.surface-container-low;

        // Right border separator
        Rectangle {
            x: parent.width - 1px;
            width: 1px;
            background: MaterialPalette.outline-variant;
        }

        VerticalLayout {
            padding: MaterialStyleMetrics.padding-16;
            spacing: MaterialStyleMetrics.spacing-16;

            // ================================================================
            // TOOL SELECTION SECTION
            // ================================================================
            MaterialText {
                text: "Drawing Tools";
                style: MaterialTypography.title-small;
                color: MaterialPalette.on-surface-variant;
            }

            // Tool buttons in a vertical grid
            VerticalLayout {
                spacing: 8px;

                ToolButton {
                    label: "Bounding Box";
                    icon-source: Icons.bounding_box;
                    is-active: root.current-tool == "BBox (B)";
                    bg-color: MaterialPalette.primary-container;
                    bg-active-color: MaterialPalette.primary;
                    icon-color: MaterialPalette.on-primary-container;
                    icon-active-color: MaterialPalette.on-primary;
                    label-color: MaterialPalette.on-primary-container;
                    label-active-color: MaterialPalette.on-primary;
                    clicked => { root.tool-selected("bbox"); }
                }

                ToolButton {
                    label: "Center Point";
                    icon-source: Icons.center_point;
                    is-active: root.current-tool == "Point (C)";
                    bg-color: MaterialPalette.tertiary-container;
                    bg-active-color: MaterialPalette.tertiary;
                    icon-color: MaterialPalette.on-tertiary-container;
                    icon-active-color: MaterialPalette.on-tertiary;
                    label-color: MaterialPalette.on-tertiary-container;
                    label-active-color: MaterialPalette.on-tertiary;
                    clicked => { root.tool-selected("point"); }
                }

                ToolButton {
                    label: "Segmentation";
                    icon-source: Icons.polygon;
                    is-active: root.current-tool == "Polygon (Hold S)";
                    bg-color: MaterialPalette.secondary-container;
                    bg-active-color: MaterialPalette.secondary;
                    icon-color: MaterialPalette.on-secondary-container;
                    icon-active-color: MaterialPalette.on-secondary;
                    label-color: MaterialPalette.on-secondary-container;
                    label-active-color: MaterialPalette.on-secondary;
                    clicked => { root.tool-selected("polygon"); }
                }
            }

            // Divider
            Rectangle {
                height: 1px;
                background: MaterialPalette.outline-variant;
            }

            // ================================================================
            // CLASSES/HIERARCHY SECTION HEADER
            // ================================================================
            MaterialText {
                text: root.hierarchy-mode ? "Hierarchy" : "Classes";
                style: MaterialTypography.title-small;
                color: MaterialPalette.on-surface-variant;
            }

            // ================================================================
            // HIERARCHY BREADCRUMB (shown when in hierarchy mode)
            // ================================================================
            if root.hierarchy-mode && root.hierarchy-breadcrumb != "" : Rectangle {
                height: 32px;
                background: MaterialPalette.secondary-container;
                border-radius: 8px;

                HorizontalLayout {
                    padding: 8px;
                    MaterialText {
                        text: root.hierarchy-breadcrumb;
                        color: MaterialPalette.on-secondary-container;
                        style: MaterialTypography.label-medium;
                        vertical-alignment: center;
                    }
                }
            }

            // ================================================================
            // HIERARCHY OPTIONS LIST (shown in hierarchy mode)
            // ================================================================
            if root.hierarchy-mode : ListView {
                for item in root.hierarchy-options : Rectangle {
                    height: 40px;
                    background: transparent;

                    HorizontalLayout {
                        spacing: 12px;
                        padding: 4px;

                        // Key badge (shows the keyboard shortcut number)
                        Rectangle {
                            width: 24px;
                            height: 24px;
                            border-radius: 12px;
                            background: MaterialPalette.secondary-container;
                            y: (parent.height - self.height) / 2;

                            MaterialText {
                                text: item.key;
                                style: MaterialTypography.label-small;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                                color: MaterialPalette.on-secondary-container;
                            }
                        }

                        // Option label
                        MaterialText {
                            text: item.label;
                            style: MaterialTypography.body-medium;
                            vertical-alignment: center;
                            color: MaterialPalette.on-surface;
                            horizontal-stretch: 1;
                        }

                        // Arrow indicator (shown for non-leaf items)
                        if !item.is-leaf : MaterialText {
                            text: "â–¶";
                            style: MaterialTypography.label-small;
                            color: MaterialPalette.outline;
                            vertical-alignment: center;
                        }
                    }

                    // Click handler
                    TouchArea {
                        clicked => {
                            root.hierarchy-key-pressed(item.key);
                        }
                    }
                }
            }

            // ================================================================
            // CLASS LIST (shown in normal mode)
            // ================================================================
            if !root.hierarchy-mode : ListView {
                for item in root.classes : Rectangle {
                    height: 44px;
                    background: root.current-class == item.id ? MaterialPalette.surface-container-highest : transparent;
                    border-radius: 8px;

                    HorizontalLayout {
                        spacing: 10px;
                        padding: 8px;

                        // Color indicator bar
                        Rectangle {
                            width: 4px;
                            height: 28px;
                            y: (parent.height - self.height) / 2;
                            background: item.color;
                            border-radius: 2px;
                        }

                        // Keyboard shortcut badge
                        Rectangle {
                            width: 28px;
                            height: 28px;
                            border-radius: 14px;
                            background: root.current-class == item.id ? MaterialPalette.primary-container : MaterialPalette.surface-container-highest;
                            y: (parent.height - self.height) / 2;

                            MaterialText {
                                text: item.shortcut;
                                style: MaterialTypography.label-medium;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                                color: root.current-class == item.id ? MaterialPalette.on-primary-container : MaterialPalette.on-surface-variant;
                            }
                        }

                        // Class name
                        MaterialText {
                            text: item.name;
                            style: MaterialTypography.body-medium;
                            vertical-alignment: center;
                            color: root.current-class == item.id ? MaterialPalette.primary : MaterialPalette.on-surface;
                        }
                    }

                    // Click handler
                    TouchArea {
                        clicked => {
                            root.class-selected(item.id);
                        }
                    }
                }
            }
        }
    }
}
