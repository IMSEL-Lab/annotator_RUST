import { Theme } from "../theme.slint";
import { VerticalBox } from "std-widgets.slint";

// Class item for the class list
export struct ClassItem {
    id: int,
    name: string,
    color: color,
    shortcut: string,
}

// Hierarchy navigation item
export struct HierarchyOption {
    key: int,
    label: string,
    is-leaf: bool,
}

// Left sidebar component with tools and classes
export component Sidebar {
    in property <[ClassItem]> classes;
    in-out property <int> current-class: 1;
    in-out property <string> current-tool: "Neutral";
    in property <bool> show-sidebar: true;
    in property <length> sidebar-width: 250px;
    in-out property <bool> help-expanded: false;

    // Hierarchy mode
    in property <bool> hierarchy-mode: false;
    in property <string> hierarchy-breadcrumb: "";
    in property <string> hierarchy-prompt: "Select category (1-5)";
    in property <[HierarchyOption]> hierarchy-options: [];

    callback class-selected(int);
    callback tool-selected(string);
    callback hierarchy-key-pressed(int);

    width: root.show-sidebar ? root.sidebar-width : 0px;
    horizontal-stretch: 0;

    Rectangle {
        width: 100%;
        background: Theme.current.bg-light;
        visible: root.show-sidebar;

        VerticalBox {
            padding: 0px;
            spacing: 0px;

            // Tools Section
            Rectangle {
                height: 140px;
                background: Theme.current.bg-light;

                VerticalBox {
                    padding: 12px;
                    spacing: 8px;

                    Text {
                        text: "Tools";
                        color: Theme.current.text-primary;
                        font-size: 14px;
                        font-weight: 600;
                    }

                    Rectangle {
                        height: 1px;
                        background: Theme.current.border-light;
                    }

                    // BBox Tool
                    bbox-tool := Rectangle {
                        height: 28px;
                        background: root.current-tool == "BBox (B)" ? Theme.current.accent-primary.with-alpha(0.2) :
                                   (bbox-tool-touch.has-hover ? Theme.current.bg-hover : transparent);
                        border-radius: 4px;

                        HorizontalLayout {
                            padding: 6px;
                            spacing: 8px;

                            Rectangle {
                                width: 20px;
                                height: 20px;
                                background: Theme.current.accent-primary;
                                border-radius: 2px;
                            }

                            Text {
                                text: "Bounding Box";
                                color: Theme.current.text-primary;
                                font-size: 13px;
                                vertical-alignment: center;
                            }

                            Rectangle { }

                            Text {
                                text: "B";
                                color: Theme.current.text-secondary;
                                font-size: 11px;
                                vertical-alignment: center;
                            }
                        }

                        bbox-tool-touch := TouchArea {
                            clicked => {
                                root.tool-selected("bbox");
                            }
                        }
                    }

                    // Point Tool
                    point-tool := Rectangle {
                        height: 28px;
                        background: root.current-tool == "Point (C)" ? Theme.current.accent-primary.with-alpha(0.2) :
                                   (point-tool-touch.has-hover ? Theme.current.bg-hover : transparent);
                        border-radius: 4px;

                        HorizontalLayout {
                            padding: 6px;
                            spacing: 8px;

                            Rectangle {
                                width: 20px;
                                height: 20px;
                                background: Theme.current.accent-secondary;
                                border-radius: 10px;
                            }

                            Text {
                                text: "Center Point";
                                color: Theme.current.text-primary;
                                font-size: 13px;
                                vertical-alignment: center;
                            }

                            Rectangle { }

                            Text {
                                text: "C";
                                color: Theme.current.text-secondary;
                                font-size: 11px;
                                vertical-alignment: center;
                            }
                        }

                        point-tool-touch := TouchArea {
                            clicked => {
                                root.tool-selected("point");
                            }
                        }
                    }

                    // Polygon Tool
                    polygon-tool := Rectangle {
                        height: 28px;
                        background: root.current-tool == "Polygon (Hold S)" ? Theme.current.accent-primary.with-alpha(0.2) :
                                   (polygon-tool-touch.has-hover ? Theme.current.bg-hover : transparent);
                        border-radius: 4px;

                        HorizontalLayout {
                            padding: 6px;
                            spacing: 8px;

                            Rectangle {
                                width: 20px;
                                height: 20px;
                                background: Theme.current.accent-warning;
                                border-radius: 2px;
                            }

                            Text {
                                text: "Polygon";
                                color: Theme.current.text-primary;
                                font-size: 13px;
                                vertical-alignment: center;
                            }

                            Rectangle { }

                            Text {
                                text: "S";
                                color: Theme.current.text-secondary;
                                font-size: 11px;
                                vertical-alignment: center;
                            }
                        }

                        polygon-tool-touch := TouchArea {
                            clicked => {
                                root.tool-selected("polygon");
                            }
                        }
                    }
                }
            }

            // Divider
            Rectangle {
                height: 1px;
                background: Theme.current.border-dark;
            }

            // Classes Section (Hierarchy Mode)
            if root.hierarchy-mode: Rectangle {
                background: Theme.current.bg-light;

                VerticalBox {
                    padding: 12px;
                    spacing: 8px;

                    Text {
                        text: "Classes (Hierarchical)";
                        color: Theme.current.text-primary;
                        font-size: 14px;
                        font-weight: 600;
                    }

                    Rectangle {
                        height: 1px;
                        background: Theme.current.border-light;
                    }

                    // Breadcrumb
                    if root.hierarchy-breadcrumb != "": Rectangle {
                        height: 28px;
                        background: Theme.current.bg-medium;
                        border-radius: 4px;

                        HorizontalLayout {
                            padding: 8px;
                            spacing: 4px;

                            Text {
                                text: root.hierarchy-breadcrumb;
                                color: Theme.current.text-secondary;
                                font-size: 11px;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // Prompt
                    Text {
                        text: root.hierarchy-prompt;
                        color: Theme.current.text-secondary;
                        font-size: 11px;
                    }

                    // Hierarchy options
                    for option in root.hierarchy-options: hierarchy-option-rect := Rectangle {
                        height: 32px;
                        background: hierarchy-option-touch.has-hover ? Theme.current.bg-hover : transparent;
                        border-radius: 4px;

                        HorizontalLayout {
                            padding: 6px;
                            spacing: 8px;

                            // Key indicator with color coding
                            Rectangle {
                                width: 24px;
                                height: 24px;
                                background: option.key == 1 ? #4A90E2 :  // Blue
                                           option.key == 2 ? #50C878 :  // Green
                                           option.key == 3 ? #E24A4A :  // Red
                                           option.key == 4 ? #F5A623 :  // Orange
                                           option.key == 5 ? #9B59B6 :  // Purple
                                           Theme.current.accent-primary;
                                border-radius: 4px;

                                Text {
                                    text: option.key;
                                    color: #ffffff;
                                    font-size: 13px;
                                    font-weight: 700;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                            }

                            // Label
                            Text {
                                text: option.label;
                                color: Theme.current.text-primary;
                                font-size: 13px;
                                vertical-alignment: center;
                            }

                            // Leaf indicator
                            if !option.is-leaf: Text {
                                text: "▶";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                                vertical-alignment: center;
                            }
                        }

                        hierarchy-option-touch := TouchArea {
                            clicked => {
                                root.hierarchy-key-pressed(option.key);
                            }
                        }
                    }

                    // Help text
                    Rectangle {
                        height: 1px;
                        background: Theme.current.border-light;
                    }

                    Text {
                        text: "Press ESC to go back";
                        color: Theme.current.text-secondary;
                        font-size: 10px;
                    }
                }
            }

            // Classes Section (Flat Mode)
            if !root.hierarchy-mode: Rectangle {
                background: Theme.current.bg-light;

                VerticalBox {
                    padding: 12px;
                    spacing: 8px;

                    Text {
                        text: "Classes";
                        color: Theme.current.text-primary;
                        font-size: 14px;
                        font-weight: 600;
                    }

                    Rectangle {
                        height: 1px;
                        background: Theme.current.border-light;
                    }

                    // Class list
                    for class-item[index] in root.classes: class-item-rect := Rectangle {
                        height: 32px;
                        background: root.current-class == class-item.id ? Theme.current.accent-primary.with-alpha(0.2) :
                                   (class-item-touch.has-hover ? Theme.current.bg-hover : transparent);
                        border-radius: 4px;

                        HorizontalLayout {
                            padding: 6px;
                            spacing: 8px;

                            // Color indicator
                            Rectangle {
                                width: 18px;
                                height: 18px;
                                background: class-item.color;
                                border-radius: 3px;
                                border-width: 1px;
                                border-color: Theme.current.border-light;
                            }

                            // Shortcut key
                            Text {
                                text: class-item.shortcut;
                                color: Theme.current.text-secondary;
                                font-size: 12px;
                                font-weight: 600;
                                vertical-alignment: center;
                                width: 20px;
                            }

                            // Class name
                            Text {
                                text: class-item.name;
                                color: Theme.current.text-primary;
                                font-size: 13px;
                                vertical-alignment: center;
                            }
                        }

                        class-item-touch := TouchArea {
                            clicked => {
                                root.class-selected(class-item.id);
                            }
                        }
                    }
                }
            }

            // Help Section (Collapsible)
            Rectangle {
                background: Theme.current.bg-light;

                VerticalBox {
                    padding: 12px;
                    spacing: 8px;

                    // Header (clickable to toggle)
                    Rectangle {
                        height: 24px;
                        background: help-header-touch.has-hover ? Theme.current.bg-hover : transparent;
                        border-radius: 4px;

                        HorizontalLayout {
                            padding-left: 4px;
                            padding-right: 4px;

                            Text {
                                text: root.help-expanded ? "▼" : "▶";
                                color: Theme.current.text-secondary;
                                font-size: 12px;
                                vertical-alignment: center;
                                width: 16px;
                            }

                            Text {
                                text: "Quick Reference";
                                color: Theme.current.text-primary;
                                font-size: 14px;
                                font-weight: 600;
                                vertical-alignment: center;
                            }
                        }

                        help-header-touch := TouchArea {
                            clicked => {
                                root.help-expanded = !root.help-expanded;
                            }
                        }
                    }

                    // Help content (only shown when expanded)
                    if root.help-expanded: Rectangle {
                        background: Theme.current.bg-medium;
                        border-radius: 4px;

                        VerticalBox {
                            padding: 8px;
                            spacing: 6px;

                            Text {
                                text: "Drawing";
                                color: Theme.current.text-primary;
                                font-size: 11px;
                                font-weight: 600;
                            }

                            Text {
                                text: "• B - BBox (drag to draw)";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                            }

                            Text {
                                text: "• C - Center Point (click)";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                            }

                            Text {
                                text: "• S - Polygon (hold, click vertices)";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                            }

                            Rectangle {
                                height: 1px;
                                background: Theme.current.border-light;
                            }

                            Text {
                                text: "Editing";
                                color: Theme.current.text-primary;
                                font-size: 11px;
                                font-weight: 600;
                            }

                            Text {
                                text: "• Click - Select annotation";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                            }

                            Text {
                                text: "• A - Auto-resize selected (1.2x)";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                            }

                            Text {
                                text: "• Delete - Remove selected";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                            }

                            Text {
                                text: "• 1-5 - Assign class";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                            }

                            Text {
                                text: "• Ctrl+C - Copy selected";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                            }

                            Text {
                                text: "• Ctrl+V - Paste annotation";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                            }

                            Rectangle {
                                height: 1px;
                                background: Theme.current.border-light;
                            }

                            Text {
                                text: "Navigation";
                                color: Theme.current.text-primary;
                                font-size: 11px;
                                font-weight: 600;
                            }

                            Text {
                                text: "• ←/→ - Previous/Next image";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                            }

                            Text {
                                text: "• F - Mark frame complete";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                            }

                            Text {
                                text: "• H - Reset view (fit to screen)";
                                color: Theme.current.text-secondary;
                                font-size: 10px;
                            }
                        }
                    }
                }
            }
        }
    }
}
